<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="../../css/themes/metro-white/easyui.css" />
<link rel="stylesheet" type="text/css" href="../../css/themes/metro-white/hdStyle.css" />
<link rel="stylesheet" type="text/css" href="../../css/style.css" />
<link rel="stylesheet" type="text/css" href="../../css/WdatePicker.css" />
<link rel="stylesheet" type="text/css" href="../../css/skin_/form.css" />
<script type="text/javascript" src="../../js/jquery.js"></script>
<script type="text/javascript" src="../../js/global.js"></script>
<script type="text/javascript" src="../../js/jquery.select.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/themes/icon.css" />
<link rel="shortcut icon" type="image/x-icon" href="../../images/favicon.ico" />

<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script src="../../js/jquery.cycle.all.min.js"></script>
<script src="../../js/jquery.jcarousel.min.js"></script>
<script src="../../js/jquery.easyui.min.js"></script>
<script src="../../js/plugins/jquery.international.js"></script>
<script type="text/javascript" src="../../js/datagrid-bufferview.js"></script>
<script type="text/javascript" src="../../js/jquery.json-2.4.js"></script>
<script type="text/javascript" src="../../js/jquery-migrate-1.2.1.min.js"></script>
<link type="text/css" rel="stylesheet" href="../../login/css/jsmind.css" />

<script charset="utf-8" src="../../js/ueditor/ueditor.config.js"></script>
<script charset="utf-8" src="../../js/ueditor/ueditor.all.min.js"></script>
<script charset="utf-8" src="../../js/ueditor/lang/zh-cn/zh-cn.js"></script>
<script charset="utf-8" src="../../js/ueditor/ueditor.all.js"></script>

<script type="text/javascript">
  $.hd = $.hd || {};
  $.fn.form.methods.defaultSubmit = $.fn.form.methods.submit || function() {  };
</script>
<!-- END: 在公司idev库之前执行 -->
<script type="text/javascript" src="../../js/datagrid-dnd.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.tabs.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.combo.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.datagrid.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.form.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.datebox.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.datetimebox.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.combogrid.js"></script>
<script src="../../js/hdEzuiEx_js/ezui.ex.treegrid.js"></script>
<script src="../../js/hdEzuiEx_js/HdObject.js"></script>
<script src="../../js/hdEzuiEx_js/HdConditions.js"></script>
<script src="../../js/hdUtils/HdUtils.js"></script>
<script src="../../js/hdUtils/commonUtils.js"></script>
<script src="../../js/hdEzuiEx_js/HdEzuiQueryParams.js"></script>
<script src="../../js/hdEzuiEx_js/ezuiCode.js" type="text/javascript"></script>
<script src="../../js/hdEzuiEx_js/ezuiComboGridCode.js" type="text/javascript"></script>
<script type="text/javascript" src="../../js/hdEzuiEx_js/extension.js"></script>
<script type="text/javascript" src="../../js/huadong/main.js"></script>
<!--<script type="text/javascript" src="../../js/huadong/hdMenu.js"></script>-->
<!-- 下拉 -->
<script type="text/javascript" src="../../js/hdDropList/comboDropListBase.js"></script>
<!-- BEGIN: 国际化 -->
<script type="text/javascript"  src="../../js/jquery.i18n.properties-min-1.0.9.js"></script>
<script id="language2" src="../../js/hdEzuiEx_js/ezuiEx-lang-zh.js"></script>
<script id="language" src="../../i18n/locale/easyui-lang-zh.js" type="text/javascript"></script>
<!--<link rel="stylesheet" type="text/css" href="../../css/colorpicker.css"/>-->
<!--<script src="../../js/colorpicker.js" type="text/javascript"></script>-->
<!-- 工具栏 -->

  <div id="uploadMaintainToolBar" style="float:left;margin-top: 2px;">
    <input type="file" id="selectFilePath" name="Url" maxlength="500" data-options="选择上传文件..." class="easyui-filebox" hidden onchange="UpladFile()"/>
    <input type="button" id="uploadBtn" class="button" value="上传文件" />
    <!--<input type="button" class="button" id="editBtn" value="编辑"/>-->
    <input type="button" class="button" id="saveBtn" value="保存"/>
  </div>
<div class="easyui-layout" data-options="fit: true">
  <!--,fit:true class="easyui-panel" 这里是否需要需经过测试才可以-->
<div data-options="region:'center',split:false,collapsible:false,border:false,fit:true" class="easyui-panel" style="margin-left: 50px;margin-top: 10px;width: 200px;height:250px;">
  <table id="uploadMaintainDatagrid" style="height:100%;"></table>
</div>
  <div data-options="region:'south',split:false,collapsible:false,border:false,fit:true" class="easyui-panel" style="height:500px;margin-left: 50px;margin-top: 10px;">
    <table id="uploadMaintainDatagrid2" style="height:100%;"></table>
</div>
</div>


<!-- 脚本控制 -->
<script src="../../js/huadong/uploadFile.js"></script>
<script src="../../js/huadong/tips.js"></script>
<script type="text/javascript">
  $("#saveBtn").hide();
  var editIndex1 = undefined;
  var editIndex2 = undefined;
  //判断是否结束编辑
  function endEditing(){
    var dg = $("#uploadMaintainDatagrid");
    if (editIndex1 == undefined){return true}
    if (dg.datagrid('validateRow', editIndex1)){
      dg.datagrid('getEditor', {index : editIndex1,field : 'thCargoTotal'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'thCargoTotal'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'cargoTotalPer'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'thCntrTotal'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'thCntrPlan'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'cntrTotalPer'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'dailyTotal'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'throuthputNTC'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'throughputGOCT'});
      dg.datagrid('getEditor', {index : editIndex1,field : 'throughputNICT'});
      editIndex1 = undefined;
      return true;
    } else {
      return false;
    }
  }
  //判断是否结束编辑
  function endEditing2(){
    var dg2 = $("#uploadMaintainDatagrid2");
    if (editIndex2 == undefined){return true}
    if (dg2.datagrid('validateRow', editIndex2)){
      dg2.datagrid('getEditor', {index : editIndex2,field : 'totalStore'});
      dg2.datagrid('getEditor', {index : editIndex2,field : 'oreStore'});
      dg2.datagrid('getEditor', {index : editIndex2,field : 'coalStore'});
      dg2.datagrid('getEditor', {index : editIndex2,field : 'steelStore'});
      dg2.datagrid('getEditor', {index : editIndex2,field : 'foodStore'});
      editIndex2 = undefined;
      return true;
    } else {
    return false;
    }
  }
  //选中编辑行
  function onClickRow(index){
    var dg = $("#uploadMaintainDatagrid");
    if (editIndex1 != index) {
      if (endEditing()) {
        dg.datagrid('selectRow', index)
          .datagrid('beginEdit', index);
        editIndex1 = index;
      } else {
        dg.datagrid('selectRow', editIndex1);
      }
    }
  }

  //选中编辑行
  function onClickRow2(index){
    var dg2 = $("#uploadMaintainDatagrid2");

    if (editIndex2 != index){
      if (endEditing2()){
        dg2.datagrid('selectRow', index)
          .datagrid('beginEdit', index);
        editIndex2 = index;
      } else {
        dg2.datagrid('selectRow', editIndex2);
      }
    }
  }


  $(document).ready(function () {
      var dg = $("#uploadMaintainDatagrid");
      var dg2 = $("#uploadMaintainDatagrid2");
      //上传
      $("#uploadBtn").on("click", function () {
        $("#selectFilePath").trigger("click");
      });
      // 保存。
      $("#saveBtn").on("click", function() {
        dg.datagrid('endEdit', editIndex1);
        dg2.datagrid("endEdit",editIndex2);
        var updated =dg.datagrid('getChanges');
        var updated2=dg2.datagrid('getChanges');

        if (updated.length < 1) {
          editIndex1 = undefined;
          $('#uploadMaintainDatagrid').datagrid('unselectAll');
          return;
        } else {
          // 传值
          var row=dg.datagrid('getSelected');
          var index=dg.datagrid('getRowIndex');
          submitFormTh(row);
        }
        if (updated2.length < 1) {
          editIndex2 = undefined;
          dg2.datagrid('unselectAll');
          return;
        } else {
          // 传值
          var row2=dg.datagrid('getSelected');
          var index2=dg.datagrid('getRowIndex');
          submitFormBulk(row2);
        }

        editIndex1 = undefined;
        editIndex2 = undefined;
        dg.datagrid('refreshRow', index);
        dg2.datagrid('refreshRow', index2);
        });

      $("#uploadMaintainDatagrid2").datagrid({
        striped:true,
        url:"/login/bulkStore/getDaily",
        method: "GET",
        singleSelect: true,
        selectOnCheck:false,
        checkOnSelect:false,
        remoteSort:false,
        rownumbers: true,
        fit: true,
        fitColumns: false,
        columns: [[
          {
            field: "terShortname",
            title: "公司",
            multiSort: true,
            halign: "center",
            sortable: true,
            width:80
          },
          {
            field: "totalStore",
            title: "库存",
            multiSort: true,
            halign: "center",
            width:80,
            editor: {type: "numberbox",options:{precision:1}},
            sortable: true
          },
          {
            field: "oreStore",
            title: "矿石",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:1}},
            sortable: true,
            width:80
          },
          {
            field: "coalStore",
            title: "煤炭",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:1}},
            sortable: true,
            width:80
          },
          {
            field: "foodStore",
            title: "粮食（含豆粕）",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:1}},
            sortable: true,
            width:80
          },
          {
            field: "steelStore",
            title: "钢材",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:1}},
            sortable: true,
            width:80
          },
          {
            field: "insAccount",
            title: "创建人",
            multiSort: true,
            halign: "center",
            width:100,
            sortable: true
          },
          {
            field: "insTimestamp",
            title: "创建时间",
            multiSort: true,
            halign: "center",
            width:140,
            formatter: HdUtils.formatter.datetime,
            sortable: true
          },
          {
            field: "updAccount",
            title: "更新人",
            multiSort: true,
            halign: "center",
            width:100,
            sortable: true
          },
          {
            field: "updTimestamp",
            title: "更新时间",
            multiSort: true,
            halign: "center",
            width:140,
            formatter: HdUtils.formatter.datetime,
            sortable: true
          }
        ]],
        onBeforeEdit:function(index,row){
//          row.editing = true;
          editIndex2 = index;
          dg2.datagrid('refreshRow', index);
        },
        onAfterEdit:function(index,row,changes){
          var updated = $('#uploadMaintainDatagrid2').datagrid('getChanges', 'updated');
          if (updated.length < 1) {
            editIndex2 = undefined;
            $('#uploadMaintainDatagrid2').datagrid('unselectAll');
            return;
          } else {
            // 传值
            submitFormBulk(row);
          }
//          row.editing = false;
          editIndex2 = undefined;
          dg2.datagrid('refreshRow', index);
        },
        onCancelEdit:function(index,row){
//          row.editing = false;
          editIndex2 = undefined;
          dg2.datagrid('refreshRow', index);
        },
        //双击单元格编辑
        onDblClickCell: function (index) {
            $("#saveBtn").show();
          dg2.datagrid("hdEdit");
          onClickRow2(index);
          editIndex2=index;
        }
      });
$("#uploadMaintainDatagrid").datagrid({
        striped:true,
        url:"/login/throughput/getCurrentThroughput",
        method: "GET",
        singleSelect: true,
        selectOnCheck:false,
        checkOnSelect:false,
        remoteSort:false,
        rownumbers: true,
        toolbar: "#uploadMaintainToolBar",
        fit: true,
        fitColumns: false,
        columns: [[
          {
            field: "thCargoTotal",
            title: "货物吞吐量累计",
            multiSort: true,
            halign: "center",
            sortable: true,
            editor: {type: "numberbox", options: {precision:2}},
            width:95
          },
          {
            field: "thCargoPlan",
            title: "每月货物吞吐量计划",
            multiSort: true,
            halign: "center",
            editor: {type: "validatebox", options: {validType: 'length[0,200]'}},
            sortable: true,
            width:120
          },
          {
            field: "cargoTotalPer",
            title: "%",
            multiSort: true,
            halign: "center",
            width:90,
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true
          },
          {
            field: "thCntrTotal",
            title: "集装箱吞吐量累计",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true,
            width:100
          },
          {
            field: "thCntrPlan",
            title: "每月集装箱吞吐量计划",
            multiSort: true,
            halign: "center",
            editor: {type: "validatebox", options: {validType: 'length[0,200]'}},
            sortable: true,
            width:130
          },
          {
            field: "cntrTotalPer",
            title: "%",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true,
            width:80
          },
          {
            field: "dailyTotal",
            title: "南沙",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true,
            width:80
          },
          {
            field: "throuthputNTC",
            title: "南沙一期",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true,
            width:80
          },
          {
            field: "throughputGOCT",
            title: "南沙二期",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true,
            width:80
          },
          {
            field: "throughputNICT",
            title: "南沙三期",
            multiSort: true,
            halign: "center",
            editor: {type: "numberbox",options:{precision:2}},
            sortable: true,
            width:80
          },
          {
            field: "insAccount",
            title: "创建人",
            multiSort: true,
            halign: "center",
            width:100,
            sortable: true
          },
          {
            field: "insTimestamp",
            title: "创建时间",
            multiSort: true,
            halign: "center",
            width:140,
            formatter: HdUtils.formatter.datetime,
            sortable: true
          },
          {
            field: "updAccount",
            title: "更新人",
            multiSort: true,
            halign: "center",
            width:100,
            sortable: true
          },
          {
            field: "updTimestamp",
            title: "更新时间",
            multiSort: true,
            halign: "center",
            width:140,
            formatter: HdUtils.formatter.datetime,
            sortable: true
          }
        ]],
        onBeforeEdit:function(index,row){
          row.editing = true;
          dg.datagrid('refreshRow', index);
        },
        onAfterEdit:function(index,row){
          row.editing = false;
          dg.datagrid('refreshRow', index);
        },
        onCancelEdit:function(index,row){
          row.editing = false;
          dg.datagrid('refreshRow', index);
        },
        //双击单元格编辑
        onDblClickCell: function (index) {
          $("#saveBtn").show();
          dg.datagrid("hdEdit");
          onClickRow(index);
          editIndex1=index;
        }

      });
//提交数据Throuput
    function submitFormTh(row) {
      $.ajax({
        type : "post",
        url : "/login/throughput/save",
        dataType: "json",
        contentType: "application/json",
        data : JSON.stringify({
          "throughputId":row.throughputId,
          "thCargoTotal":row.thCargoTotal,
          "thCargoPlan":row.thCargoPlan,
          "cargoTotalPer": row.cargoTotalPer,
          "thCntrTotal":row.thCntrTotal,
          "thCntrPlan":row.thCntrPlan,
          "cntrTotalPer":row.cntrTotalPer,
          "dailyTotal":row.dailyTotal,
          "throuthputNTC":row.throuthputNTC,
          "throughputGOCT":row.throughputGOCT,
          "throughputNICT":row.throughputNICT,
          "insAccount":row.insAccount,
          "insTimestamp":row.insTimestamp
        }),
        success : function(data) {
            if (data != ""){
              $("#saveBtn").hide();
              dg.datagrid('reload');
            }
        },
        error: function (data) {
          console.info(data);
        }
      });
    }

//提交数据BULKSTORE
    function submitFormBulk(row) {
        console.log(row);
      $.ajax({
        type : "post",
//        async : false,
        url : "/login/bulkStore/save",
        dataType: "json",
        contentType: "application/json",
        data : JSON.stringify({
            "bulkStoreId":row.bulkStoreId,
          "terCode":row.terCode,
          "totalStore" : row.totalStore,
          "oreStore":row.oreStore,
          "coalStore":row.coalStore,
          "foodStore":row.foodStore,
          "steelStore":row.steelStore,
          "insAccount":row.insAccount,
          "insTimeStamp":row.insTimestamp
        }),
        success : function(data) {
            console.log(data);
          if(data!=""){
            $("#saveBtn").hide();
            dg2.datagrid('reload');
          }
        },
        error: function (data) {
          console.info(data);
        }
      });
    }
    });




</script>
